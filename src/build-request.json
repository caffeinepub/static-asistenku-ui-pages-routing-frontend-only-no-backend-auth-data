{
  "kind": "build_request",
  "title": "Backend-only: Append-only Layanan V4 (internal-managed service instances)",
  "projectName": "Asistenku",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-200",
      "text": "Modify ONLY `backend/main.mo` to implement the new “Layanan V4” system strictly as an append-only change: add all new code at the very end of the actor (immediately before the final closing brace `}`) without modifying, deleting, moving, reformatting, or reorganizing any existing lines. Do not create any new files.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-build-sekarang",
          "msg-user-layanan-v4-rules"
        ],
        "quotes": [
          "Ya — larangan lama (backend zero-diff) untuk bagian ini DICABUT. ... Hanya append di akhir.",
          "Anda HANYA boleh mengubah backend/main.mo dengan cara: MENAMBAHKAN kode baru di BAGIAN AKHIR file (append-only)."
        ]
      },
      "acceptanceCriteria": [
        "The only file changed is `backend/main.mo`.",
        "All existing code in `backend/main.mo` remains byte-for-byte unchanged (no edits above the appended block).",
        "No new files are created (including no `migration.mo` changes/usage)."
      ]
    },
    {
      "id": "REQ-201",
      "text": "In the appended block, define the Layanan V4 types exactly as specified: `public type LayananTypeV4 = { #TENANG; #RAPI; #FOKUS; #JAGA; #EFEKTIF };` and `public type LayananV4 = { id: Text; clientPrincipal: Principal; tipe: LayananTypeV4; unitTotal: Nat; unitUsed: Nat; hargaPerUnit: Nat; asistenmuPrincipal: Principal; sharedWith: [Principal]; isActive: Bool; isArchived: Bool; createdAt: Int; createdBy: Principal; updatedAt: Int; updatedBy: Principal; };`.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-layanan-v4-types"
        ],
        "quotes": [
          "Tambahkan type: public type LayananTypeV4 = { #TENANG; #RAPI; #FOKUS; #JAGA; #EFEKTIF };",
          "public type LayananV4 = { id: Text; clientPrincipal: Principal; tipe: LayananTypeV4; unitTotal: Nat; unitUsed: Nat; hargaPerUnit: Nat; asistenmuPrincipal: Principal; sharedWith: [Principal]; isActive: Bool; isArchived: Bool; createdAt: Int; createdBy: Principal; updatedAt: Int; updatedBy: Principal; };"
        ]
      },
      "acceptanceCriteria": [
        "Both types compile and are publicly available from the canister interface.",
        "The variant names and record field names/types match the spec exactly (including capitalization)."
      ]
    },
    {
      "id": "REQ-202",
      "text": "In the appended block, add new stable storage dedicated to V4 only (unique names; do not collide with existing vars): `stable var layananV4Counter : Nat = 0;`, `stable var layananV4Store : [(Text, LayananV4)] = [];`, and `stable var layananV4IndexByClient : [(Principal, [Text])] = [];`. Also add runtime `HashMap`/`Map` structures for fast access: (1) `layananV4ById` keyed by `Text` and (2) `layananV4IdsByClient` keyed by `Principal` to `[Text]`. Keep the stable and runtime stores consistent on every mutation.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-layanan-v4-storage"
        ],
        "quotes": [
          "Tambahkan stable vars baru ... layananV4Counter ... layananV4Store ... layananV4IndexByClient",
          "Buat runtime map baru (HashMap) untuk: layananV4ById, layananV4IdsByClient"
        ]
      },
      "acceptanceCriteria": [
        "After a successful create/edit/toggle/archive, subsequent queries reflect the updated data and indexes (by id and by client).",
        "State persists across upgrades using the new stable vars (no reliance on non-stable-only runtime data)."
      ]
    },
    {
      "id": "REQ-203",
      "text": "In the appended block, implement LV4 id generation using the exact format `LV4-<Nat>` (e.g., `LV4-1`, `LV4-2`, …) based on `layananV4Counter` and ensure it increments monotonically.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-layanan-v4-id"
        ],
        "quotes": [
          "ID format: \"LV4-\" # Nat (contoh LV4-1, LV4-2, ...)."
        ]
      },
      "acceptanceCriteria": [
        "The first created record has id `LV4-1` (given initial counter 0) and each subsequent create increments by 1.",
        "IDs are never re-used within the same canister state."
      ]
    },
    {
      "id": "REQ-204",
      "text": "In the appended block, add a new internal-only authorization helper that allows only callers whose existing role is one of: `superadmin`, `admin`, or `finance`. If not allowed, it must trap with the exact message `\"Unauthorized\"`. This helper must reuse the existing role system already present in `backend/main.mo` and must not modify any existing access control logic.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-layanan-v4-auth"
        ],
        "quotes": [
          "Tambahkan helper function baru (gunakan role system yang sudah ada di main.mo): allow caller jika role-nya salah satu: superadmin/admin/finance Jika bukan, trap \"Unauthorized\"."
        ]
      },
      "acceptanceCriteria": [
        "A caller without an allowed role receives a trap with exactly `Unauthorized` when calling any Layanan V4 method.",
        "A caller with role `#superadmin` is allowed.",
        "A caller with internal role `#admin` is allowed.",
        "A caller with internal role `#finance` is allowed.",
        "No changes are made to existing AccessControl or existing role checks outside the appended code."
      ]
    },
    {
      "id": "REQ-205",
      "text": "In the appended block, implement the following public internal-only Layanan V4 methods with the exact names/parameters/behaviors specified, without changing any existing V1/V2/V3 layanan methods or other domains:\n1) `createLayananV4(input)` creates a new record: required input fields: `clientPrincipal`, `tipe`, `unitTotal`, `hargaPerUnit`, `asistenmuPrincipal`, `sharedWith` (may be empty), `isActive` (default `true` if not provided). It must set `unitUsed=0`, `isArchived=false`, set created/updated timestamps and principals to the caller, persist to store + index-by-client, and return the created `LayananV4`.\n2) `editLayananV4(layananId, patch)` allows editing ONLY: `clientPrincipal` (update index if changed), `tipe`, `unitTotal` (validate `unitTotal >= unitUsed`), `hargaPerUnit`, `asistenmuPrincipal`, `sharedWith`, `isActive`. It must NOT allow editing: `id`, `unitUsed`, `isArchived`, `createdAt`, `createdBy`. If layanan not found OR already archived, trap exactly `\"Not found\"`. If `unitTotal < unitUsed`, trap exactly `\"unitTotal cannot be less than unitUsed\"`. Must set `updatedAt/updatedBy` and return the updated `LayananV4`.\n3) `setLayananV4Active(layananId, isActive)` rejects if archived, updates `updatedAt/updatedBy`, returns updated `LayananV4`.\n4) `archiveLayananV4(layananId)` sets `isArchived=true`, `isActive=false`, updates `updatedAt/updatedBy`, returns updated `LayananV4`.\n5) `listAllLayananV4(includeArchived : Bool)` returns all V4 records, filtered by `isArchived` according to the flag.\n6) `listLayananV4ByClient(clientPrincipal, includeArchived : Bool)` returns V4 records for a specific client principal, filtered by `isArchived` according to the flag.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-layanan-v4-methods"
        ],
        "quotes": [
          "Tambahkan method berikut (semua internal-only): createLayananV4 ... editLayananV4 ... setLayananV4Active ... archiveLayananV4 ... listAllLayananV4 ... listLayananV4ByClient ...",
          "jika layanan tidak ada atau sudah archived => trap \"Not found\"",
          "jika unitTotal < unitUsed => trap \"unitTotal cannot be less than unitUsed\""
        ]
      },
      "acceptanceCriteria": [
        "All 6 methods exist and compile with the specified names.",
        "All 6 methods trap with exactly `Unauthorized` when the caller is not superadmin/admin/finance.",
        "`createLayananV4` sets `unitUsed=0` and `isArchived=false` regardless of input.",
        "`editLayananV4` traps `Not found` when the id is missing OR the record is archived.",
        "`editLayananV4` traps `unitTotal cannot be less than unitUsed` when patch reduces total below used.",
        "`setLayananV4Active` and `archiveLayananV4` do not allow operating on archived records (must reject); archived records remain archived.",
        "`listAllLayananV4(false)` excludes archived records; `listAllLayananV4(true)` includes them.",
        "`listLayananV4ByClient` returns only that client’s ids (index maintained correctly when `clientPrincipal` changes via edit)."
      ]
    },
    {
      "id": "REQ-206",
      "text": "Perform a backend compile sanity pass after implementing Layanan V4 to ensure `backend/main.mo` compiles successfully and that no existing public methods (registration, claimSuperadmin, master data, status/partner-level utilities, etc.) have changed behavior due to the append-only patch.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-build-sekarang",
          "msg-user-layanan-v4-output"
        ],
        "quotes": [
          "Build sekarang",
          "Pastikan compile. Pastikan stable upgrade aman ..."
        ]
      },
      "acceptanceCriteria": [
        "The canister builds without Motoko compiler errors.",
        "No existing method signatures are modified.",
        "No existing behavior is removed; all changes are additive and isolated to Layanan V4."
      ]
    }
  ],
  "constraints": [
    "Backend scope is append-only: add new code only at the end of `backend/main.mo`; do not modify/move/delete/reformat any existing lines.",
    "Do not create new files (including `backend/migration.mo`) and do not add/modify migration logic.",
    "Do not change, refactor, or touch any existing domains: users, tasks, master data, finance, and existing layanan V1/V2/V3.",
    "Do not change `registerClient`/`registerPartner` signatures or existing AccessControl implementation.",
    "All new Layanan V4 APIs must be internal-only, allowing only superadmin/admin/finance; otherwise trap exactly `Unauthorized`.",
    "Use the exact LV4 id format `LV4-<Nat>`.",
    "If `preupgrade`/`postupgrade` already exist, only add V4 handling blocks without changing existing logic; if they do not exist, do not introduce upgrade hooks that require modifying existing code paths."
  ],
  "nonGoals": [
    "No frontend changes (no UI/dashboard updates for Layanan V4 in this build).",
    "No changes to existing layanan V1/V2/V3 behavior or storage.",
    "No new external integrations or databases.",
    "No new routing, authentication providers, or role model redesign."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}