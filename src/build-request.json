{
  "kind": "build_request",
  "title": "Enable full Internal Login flow (Internet Identity + backend role validation) in InternalLogin.tsx only",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-83",
      "text": "Modify ONLY `frontend/src/pages/internal/InternalLogin.tsx` to implement the requested “Model A” Internal Login flow using Internet Identity login and existing backend methods (`getCallerUser()`, `isSuperadminClaimed()`, `claimSuperadmin()`) while keeping all other pages UI-only and unchanged.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Batasan UI-only untuk InternalLogin.tsx dicabut. Halaman ini sekarang BOLEH memanggil backend dan menjalankan flow login penuh (II, getCallerUser, isSuperadminClaimed, claimSuperadmin, redirect).",
          "Aturan UI-only tetap berlaku untuk halaman lain. Hanya InternalLogin.tsx yang diizinkan terhubung ke backend saat ini."
        ]
      },
      "acceptanceCriteria": [
        "Only `frontend/src/pages/internal/InternalLogin.tsx` is modified; no other frontend or backend files change; no new files are created.",
        "`/internal/login` continues to render without any auto-redirect on initial load.",
        "The page uses the existing Internet Identity provider/hook to perform II login (no custom auth implementation, no backend changes).",
        "The page uses the existing actor hook to call backend methods (no direct fetch calls)."
      ]
    },
    {
      "id": "REQ-84",
      "text": "Implement the exact InternalLogin UI state machine and backend call sequencing as specified: `iiLoggedIn`, `selectedRole`, `checking`, `warningText`, `superadminClaimed`, `claimLoading`; call `isSuperadminClaimed()` exactly once on mount to set `superadminClaimed` and do not call `getCallerUser()` automatically after II login.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "STATE UI InternalLogin:\n\niiLoggedIn: boolean\n\nselectedRole: string | null\n\nchecking: boolean\n\nwarningText: string | null\n\nsuperadminClaimed: boolean | null (loaded dari isSuperadminClaimed setelah page mount)\n\nclaimLoading: boolean\n\n\nON MOUNT:\n\npanggil isSuperadminClaimed() sekali -> set superadminClaimed (true/false)\n\njangan auto redirect apa pun\n\n\nTOMBOL “Login Internet Identity”:\n\nmelakukan login II\n\nsetelah login sukses set iiLoggedIn = true\n\njangan panggil getCallerUser otomatis setelah login"
        ]
      },
      "acceptanceCriteria": [
        "On initial mount, `isSuperadminClaimed()` is invoked exactly once and `superadminClaimed` becomes `true` or `false` (not left `null`) if the call succeeds.",
        "Clicking “Login Internet Identity” triggers II login and only updates `iiLoggedIn` after login succeeds; it does not trigger `getCallerUser()` implicitly.",
        "No automatic navigation occurs on mount or immediately after successful II login."
      ]
    },
    {
      "id": "REQ-85",
      "text": "Update the role card grid in `InternalLogin.tsx` so it always shows these clickable role cards and uses their exact role keys for selection/validation: `admin`, `asistenmu`, `concierge`, `strategicpartner`, `manajer`, `finance`, `management`, `superadmin`. Clicking a card must set `selectedRole` to that card’s role key and clear `warningText`. The Superadmin card must always exist and be selectable.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "GRID KARTU ROLE (selalu tampil): Kartu wajib: admin, asistenmu, concierge, strategicpartner, manajer, finance, management, superadmin\n\nklik kartu => set selectedRole = roleKartu dan clear warningText\n\n\nKartu “Superadmin” wajib ada dan bisa di-klik untuk masuk."
        ]
      },
      "acceptanceCriteria": [
        "The role grid contains exactly 8 cards for the required roles and remains visible regardless of login state.",
        "Selecting any card updates local UI selection styling (consistent with existing pattern) and clears any existing warning text.",
        "The selected role value used for validation matches the required role keys (lowercase strings listed in the requirement)."
      ]
    },
    {
      "id": "REQ-86",
      "text": "Enable the “Ruang kerja” action with the required gating and behavior: it must be enabled only when `iiLoggedIn === true` AND `selectedRole !== null`; on click it must set `checking=true`, clear `warningText`, call `getCallerUser()` exactly once, then enforce the specified decision tree (registration handling, role mismatch warning, status check for non-client/partner/superadmin roles) and redirect only on successful match.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "TOMBOL “Ruang kerja”:\n\nhanya aktif jika iiLoggedIn == true dan selectedRole != null\n\nsaat diklik:\n\n1. set checking = true; warningText = null\n\n\n2. panggil getCallerUser() sekali\n\n\n3. jika user == null:\n\njika selectedRole == \"superadmin\":\n\njika superadminClaimed == false: tampilkan di area kartu superadmin: tombol “Claim Superadmin” (jangan redirect ke /internal/register)\n\njika superadminClaimed == true: warningText = \"Akun belum terdaftar\" tampil tombol “Ke pendaftaran” -> /internal/register\n\n\njika selectedRole != \"superadmin\": warningText = \"Akun belum terdaftar\" tampil tombol “Ke pendaftaran” -> /internal/register set checking=false; STOP\n\n\n\n4. jika user != null:\n\njika user.role != selectedRole: warningText = \"Klik di Ruang kerja yang sesuai dengan bagian/role kamu\" set checking=false; STOP (tanpa redirect)\n\njika user.role == selectedRole:\n\njika selectedRole bukan client/partner/superadmin dan user.status != \"active\": warningText = \"Menunggu persetujuan.\" set checking=false; STOP\n\nelse redirect sesuai mapping dashboard di atas set checking=false"
        ]
      },
      "acceptanceCriteria": [
        "“Ruang kerja” is disabled unless the user is II-logged-in and a role card is selected.",
        "On click, exactly one `getCallerUser()` call is made per click.",
        "If `getCallerUser()` returns null/none and selectedRole is not `superadmin`, show warning text exactly `\"Akun belum terdaftar\"` and show a “Ke pendaftaran” link/button that navigates to `/internal/register`; no redirect occurs otherwise.",
        "If `getCallerUser()` returns null/none and selectedRole is `superadmin` and `superadminClaimed === false`, do not navigate to `/internal/register`; instead the Superadmin card area must present the “Claim Superadmin” action (per REQ-87).",
        "If `user.role` does not match `selectedRole`, show warning text exactly `\"Klik di Ruang kerja yang sesuai dengan bagian/role kamu\"` and do not redirect.",
        "If role matches and selectedRole is not `client`, `partner`, or `superadmin` and `user.status` is not exactly `\"active\"`, show warning text exactly `\"Menunggu persetujuan.\"` and do not redirect.",
        "If role matches and passes status check, navigate to the exact dashboard route for that role (see REQ-88)."
      ]
    },
    {
      "id": "REQ-87",
      "text": "Implement Superadmin claim behavior in `InternalLogin.tsx`: show a “Claim Superadmin” button only when `iiLoggedIn === true`, `selectedRole === \"superadmin\"`, and `superadminClaimed === false`. On click, set `claimLoading=true` and clear `warningText`, call `claimSuperadmin()` (no parameters; if it requires parameters in the generated types, pass empty/placeholder values without adding any form fields), then handle success/already-claimed outcomes exactly as specified and redirect only on successful claim.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "KARTU SUPERADMIN — CLAIM:\n\ntombol “Claim Superadmin” hanya tampil jika: iiLoggedIn == true AND selectedRole == \"superadmin\" AND superadminClaimed == false\n\nsaat klik “Claim Superadmin”:\n\n1. claimLoading=true; warningText=null\n\n\n2. panggil claimSuperadmin()\n\n\n3. jika hasil sukses (atau string mengandung \"CLAIMED\" / true):\n\nset superadminClaimed = true\n\nredirect /superadmin/dashboard\n\n\n\n4. jika hasil sudah claimed:\n\nset superadminClaimed = true\n\nwarningText = \"Superadmin sudah diklaim.\"\n\n\n\n5. claimLoading=false"
        ]
      },
      "acceptanceCriteria": [
        "The “Claim Superadmin” button is not visible unless the exact visibility condition is met.",
        "Clicking “Claim Superadmin” triggers exactly one backend call to `claimSuperadmin()` and shows a loading state while pending.",
        "On success (including boolean true or a string containing `\"CLAIMED\"`), the UI sets `superadminClaimed=true` and navigates to `/superadmin/dashboard`.",
        "If the backend indicates it was already claimed, the UI sets `superadminClaimed=true`, sets warning text exactly `\"Superadmin sudah diklaim.\"`, and does not redirect.",
        "No form fields are added for claiming superadmin."
      ]
    },
    {
      "id": "REQ-88",
      "text": "Implement the fixed dashboard route mapping in `InternalLogin.tsx` redirects (no route changes elsewhere): admin -> `/admin/dashboard`; asistenmu -> `/asistenmu/dashboard`; concierge -> `/concierge/dashboard`; strategicpartner -> `/strategicpartner/dashboard`; manajer -> `/manajer/dashboard`; finance -> `/finance/dashboard`; management -> `/management/dashboard`; superadmin -> `/superadmin/dashboard`.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "dashboard mapping: admin -> /admin/dashboard asistenmu -> /asistenmu/dashboard concierge -> /concierge/dashboard strategicpartner -> /strategicpartner/dashboard manajer -> /manajer/dashboard finance -> /finance/dashboard management -> /management/dashboard superadmin -> /superadmin/dashboard"
        ]
      },
      "acceptanceCriteria": [
        "InternalLogin redirects only to the exact mapped paths when validation passes.",
        "No new routes are introduced, and existing routes in `frontend/src/App.tsx` are not modified as part of this change set."
      ]
    },
    {
      "id": "REQ-89",
      "text": "Preserve the existing InternalLogin page’s base layout and styling (logo, centered container, card styling, footer). Only add the minimum UI elements needed to support the new logic: enable/disable states, per-role “Ruang kerja” placement (either per-card or a single shared button), Superadmin claim button in the Superadmin card area, and a simple warning text area displayed below the “Ruang kerja” action area.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "UI RULES:\n\nJangan ubah layout dasar yang sudah ada, hanya aktifkan logic.\n\nTidak ada auto redirect onLoad.\n\nWarning text tampil di bawah tombol “Ruang kerja” (atau area yang sudah ada) dengan style sederhana."
        ]
      },
      "acceptanceCriteria": [
        "The page remains visually consistent with its current layout structure; role cards remain in a grid; the main two existing primary actions remain present (now enabled/disabled per state).",
        "Warning text renders in a simple style beneath the “Ruang kerja” action area when `warningText` is set.",
        "No other pages’ layouts are changed."
      ]
    },
    {
      "id": "REQ-90",
      "text": "Ensure the change compiles and runs without runtime errors, including when the user is not logged in (anonymous actor), when backend calls fail, and when backend return types differ by variant (handle results defensively in `InternalLogin.tsx` without changing shared hooks).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "OUTPUT:\n\nTerapkan patch ini dan pastikan build sukses tanpa menambah file lain."
        ]
      },
      "acceptanceCriteria": [
        "TypeScript build succeeds with no new type errors in `InternalLogin.tsx`.",
        "Visiting `/internal/login` while not logged in does not crash; `isSuperadminClaimed()` failures are handled by showing a warning (or leaving `superadminClaimed` as `null`) without redirecting.",
        "Clicking “Ruang kerja” while logged in handles backend errors by setting `warningText` and resetting `checking=false` (no crash, no redirect)."
      ]
    }
  ],
  "constraints": [
    "Only modify `frontend/src/pages/internal/InternalLogin.tsx`.",
    "Do not modify `backend/main.mo`, do not add `backend/migration.mo`, and do not create any new files.",
    "Do not modify any other frontend pages (including InternalRegister and all dashboards), and keep them UI-only with no backend calls.",
    "Do not add or change any routes; keep existing route paths exactly as currently defined.",
    "No automatic redirects on page load."
  ],
  "nonGoals": [
    "Implementing or changing any backend methods or candid interfaces.",
    "Adding new pages, new routes, or changing `frontend/src/App.tsx` routing logic as part of this change.",
    "Making other pages (InternalRegister, dashboards, client/partner pages) call the backend or Internet Identity.",
    "Adding role management/admin features beyond the exact InternalLogin flow described."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}