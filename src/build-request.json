{
  "kind": "build_request",
  "title": "Append-only Ringkasan V1 summary sourced from existing LayananV4/Task/User storages",
  "projectName": "Asistenku Control Room",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-219",
      "text": "Update `backend/main.mo` using an append-only patch (additions only, placed at the end of the actor) to introduce a new summary type `SuperadminSummaryV1` and a new query method `getSuperadminSummaryV1()` that computes Ringkasan metrics in real time using ONLY existing storages/maps already present in `backend/main.mo`, specifically the legacy read-only Ringkasan data sources: `taskById`, `layananV4ById`, `userRoles`, `userStatusByPrincipal`, and `partnerLevelByPrincipal` (if present). Do not modify, delete, rename, reorder, or rewrite any existing storage declarations or existing logic; all new logic must be additive/append-only.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Semua perhitungan Ringkasan bersifat READ ONLY.\nJangan ubah, hapus, atau rewrite storage lama.\nSemua logic baru HARUS APPEND ONLY."
        ]
      },
      "acceptanceCriteria": [
        "`backend/main.mo` contains a new `public type SuperadminSummaryV1 = ...` and a new `public query ({ caller }) func getSuperadminSummaryV1() : async SuperadminSummaryV1` appended near the end of the actor without editing existing lines.",
        "`getSuperadminSummaryV1()` reads from existing maps only and does not mutate `taskById`, `layananV4ById`, `userRoles`, `userStatusByPrincipal`, `partnerLevelByPrincipal`, or any other existing storage.",
        "All calculations are derived from the described read-only sources: tasks totals derived from `taskById` and `TaskPhase`; layanan totals/GMV derived from `layananV4ById` and `LayananV4` fields (e.g., active when `isActive==true && isArchived==false`; GMV as `unitTotal * hargaPerUnit`).",
        "The new summary method is gated using existing auth helpers (reuse existing role checks/helpers already in `main.mo`); unauthorized callers cannot access the summary.",
        "No migration code is added/modified; no new files are created."
      ]
    },
    {
      "id": "REQ-220",
      "text": "Ensure the summary computations in `getSuperadminSummaryV1()` treat the existing storages as immutable inputs and follow the existing semantics described by the user: tasks active = phases not `#selesai` and not `#dibatalkan_client`; tasks selesai = phase `#selesai`; layanan active = `isActive==true && isArchived==false`; GMV total = sum of `unitTotal * hargaPerUnit` across layanan V4 records. All new computations must remain read-only and append-only.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "// taskById digunakan untuk:\n// - Hitung total task aktif (phase != #selesai dan != #dibatalkan_client)\n// - Hitung total task selesai (phase == #selesai)\n// - Konversi nilai task selesai untuk perhitungan saldo partner & margin\n//\n// layananV4ById digunakan untuk:\n// - Hitung total layanan aktif (isActive == true && isArchived == false)\n// - Hitung GMV total (unitTotal * hargaPerUnit)\n//\n// partnerLevelByPrincipal digunakan untuk:\n// - Tentukan RATE_JUNIOR / RATE_SENIOR / RATE_EXPERT"
        ]
      },
      "acceptanceCriteria": [
        "The computed values for task counts and layanan counts follow the exact phase/flag rules described in the comments.",
        "GMV is computed from V4 layanan only and matches the formula `unitTotal * hargaPerUnit` aggregated over the selected layanan set.",
        "The method does not alter any task, layanan, or user storage as part of computing summary values."
      ]
    },
    {
      "id": "REQ-221",
      "text": "Modify ONLY `frontend/src/pages/dashboards/SuperadminDashboard.tsx` to consume `actor.getSuperadminSummaryV1()` within the existing Ringkasan tab, adding minimal new local state (`summaryV1`, `summaryV1Loading`, `summaryV1Error`) and a Refresh control for this summary block only. This change must be additive and must not refactor or change the behavior/state/backend calls of the existing tabs beyond adding the new Ringkasan V1 block.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Build APPEND ONLY.\n... Semua logic baru HARUS APPEND ONLY."
        ]
      },
      "acceptanceCriteria": [
        "`SuperadminDashboard.tsx` includes a new Ringkasan section that calls `actor.getSuperadminSummaryV1()` only when the Ringkasan tab is active and the backend actor is ready.",
        "The new Ringkasan V1 UI shows calm loading and error states without crashing the dashboard.",
        "A per-section Refresh action re-fetches only the Ringkasan V1 summary data.",
        "All newly introduced user-facing strings in this new UI block are in English."
      ]
    },
    {
      "id": "REQ-222",
      "text": "Perform a compile/runtime sanity pass for the patched backend and `SuperadminDashboard.tsx` ensuring: (1) the backend compiles, (2) the dashboard does not crash in anonymous identity state (no backend calls), (3) the dashboard does not crash while the actor is initializing, and (4) unexpected/missing backend method shape errors are handled gracefully with an English error message (no raw traps shown to the user).",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Use English for any user-facing text in the build request."
        ]
      },
      "acceptanceCriteria": [
        "Backend compiles successfully after the append-only additions.",
        "When identity is anonymous, the Superadmin dashboard renders the existing login guidance view and does not call `getSuperadminSummaryV1()`.",
        "When `actor` is null/undefined or `actorFetching` is true, Ringkasan V1 does not attempt backend calls and the UI remains stable.",
        "If `actor.getSuperadminSummaryV1` is missing at runtime, the UI shows a calm English message instead of crashing."
      ]
    }
  ],
  "constraints": [
    "Backend changes must be APPEND ONLY in `backend/main.mo`: do not modify, delete, move, rename, reorder, or reformat any existing lines; add new code only at the end of the actor.",
    "Do not change, delete, or rewrite any existing storages/maps used as Ringkasan data sources (`taskById`, `layananV4ById`, `userRoles`, `userStatusByPrincipal`, `partnerLevelByPrincipal`); treat them as read-only inputs for summary.",
    "Do not add or modify `backend/migration.mo`, and do not introduce migration imports/upgrade hooks as part of this change.",
    "Frontend scope is limited to modifying ONLY `frontend/src/pages/dashboards/SuperadminDashboard.tsx` for the Ringkasan V1 UI addition; no routing changes and no new pages/files.",
    "All newly introduced user-facing strings must be in English."
  ],
  "nonGoals": [
    "Do not refactor or redesign the existing Superadmin dashboard tabs (Users, Master Data, Rates, Tasks) beyond the minimal additive Ringkasan V1 block.",
    "Do not change any existing Layanan V4 / Task / User storage schemas or indexing behavior.",
    "Do not implement new backend CRUD endpoints for Layanan V4, Tasks, or Users beyond the single summary query required here."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}